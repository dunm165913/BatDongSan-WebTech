<!doctype html>
<html lang="en">

<head>
  <title>Batdongsan</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css"
    integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ" crossorigin="anonymous">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

</head>

<body>
  <div class="container">
    <header>
      <div class="header__top">
        <div class="logo"><a href="/"><img src="img/logo.jpg" alt=""></a></div>
        <div class="topleftmobile">
          <i class="fa fa-bars" aria-hidden="true">
            <div class="nav__hover">
              <div class="user">
                <div><i class="fa fa-user-circle" aria-hidden="true"></i></div>
                <div class="log__sign"><a href="">Đăng nhập</a>|<a href="">Đăng kí</a></div>
                <a href=""><button>Đăng tin</button></a>
              </div>
              <div class="nav__list">
                <ul>
                  <li>Trang chủ</li>
                  <li>Nhà đất bán</li>
                  <li>nhà đất cho thuê</li>
                  <li>Cần mua/cần thuê</li>
                  <li style="color:green;">chat</li>
                  <li>Dự án</li>
                  <li>Danh bạ</li>
                  <li>tin tức</li>
                  <li>Xây dựng-kiến trúc</li>
                  <li>Nội-Ngoại thất</li>
                  <li>Phong thủy</li>
                  <li>Nhận bất động sản qua email</li>
                  <li>góp ý báo lỗi</li>
                  <li>giới thiệu chung</li>
                  <li>liên hệ</li>
                </ul>
              </div>
            </div>
          </i>
        </div>
        <div class="header__right">
          <div class="right__top"><img src="img/quangcao1.jpg" alt=""></div>
          <div class="right__bottom">
            <div class="right__bottom__icon">
              <img src="img/fb.png" alt="" />
              <img src="img/gg.png" alt="" />
              <img src="img/youtube.png" alt="" />
            </div>
            <div class="right__bottom__menu" style="margin-top: 3px;">
              <ul>
                <li><a href=""><img src="img/banxehoi.png" />Oto.com.vn</a></li>
                <li class="xanh"><a href=""><img src="img/plus.png" />Đăng rao tin</a></li>
                <li class="dangki" id="dangki"><img src="img/register.png" />Đăng ký</li>
                <li class="dangnhap" id='dangnhap'><img src="img/login.png" />Đăng nhập</li>
                <li><a href=""><img src="img/english.png" />English</a></li>
              </ul>

            </div>
          </div>
        </div>
      </div>

      <div class="menu">
        <nav>
          <ul>
           <a href="/"></a> <li class="itemmenu"><img src="img/homea.png" alt="" /></li></a>
            <li class="itemmenu"><a href="nhadatban">Nhà đất bán</a></li>
            <li class="itemmenu"><a href="nhadatthue">Nhà đất cho thuê</a></li>
            <li class="itemmenu"><a href="/duan">Dự án</a></li>
            <li class="itemmenu"><a href="canmuathue">Cần mua-Cần thuê</a></li>
            <li class="itemmenu"><a href="">Tin tức</a></li>
            <li class="itemmenu"><a href="">Xây dựng-Kiến trúc</a></li>
            <li class="itemmenu"><a href="">Nội - Ngoại thất</a></li>
            <li class="itemmenu"><a href="#">Phong thủy</a></li>
            <li class="itemmenu"><a href="#">Danh bạ</a></li>
          </ul>
        </nav>
      </div>
    </header>
    <!-- het header -->
    <div class="container">
      <div class="profile">
        <div class="profile__left">
          <div class="title">
            <p>TRANG CÁ NHÂN</p>
          </div>
          <div class="profile__content">
            <div class="user">

              <div><i class="fa fa-user-circle" aria-hidden="true">

                </i>
              </div>
              <div class="taikhoan">
                <p>Tài khoản rao tin: <b>0</b></p>
                <p>Tài khoản ngoài rao tin: <b>0</b></p>
                <p>Tài khoản KM1: <b>0</b></p>
                <p>Tài khoản KM2: <b>0</b></p>
              </div>
              <a href="/dangtin"><button>Đăng tin</button></a>
            </div>
            <div class="info">
              <div class="info__item">
                <div class="info__item__title">Quản lý thông tin cá nhân</div>
                <div class="info__item__list">
                  <ul>
                    <li><span id="change_profile" style="cursor: pointer;">Thay đổi thông tin cá nhân</span></li>
                    <li>
                      <sapn id="change_password" style="cursor: pointer;">Thay đổi mật khẩu</span>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="info__item">
                <div class="info__item__title">Quản lý tin đăng</div>
                <div class="info__item__list">
                  <ul>
                    <li><span id="ban" style="cursor: pointer;">Quản lý tin rao bán</sapn>
                    </li>
                    <li><span id="thue" style="cursor: pointer;">Quản lý tin cho thuê</span></li>
                    <li><span id="canban-thue" style="cursor: pointer;">Quản lý tin rao bán</sapn>
                    </li>
               
                  </ul>
                </div>
              </div>


              <div class="info__item">
                <div class="info__item__title">Hướng dẫn & báo giá</div>
                <div class="info__item__list">
                  <ul>
                    <li style="cursor: pointer;"><a href="/chitietbaiviet?id=13">Hướng dẫn sử dụng</a></li>
                    <li style="cursor: pointer;"><a href="/chitietbaiviet?id=12">Hướng dẫn thanh toán</a></li>
                   
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="profile__right" id="profile__right">
          <div class="profile__right__title">Danh sách giao dịch</div>
          <div id="img_profile"></div>
          <div class="profile__right__content">

          </div>
        </div>

        <div class="profile__right" id="sanpham">
          <div class="profile__right__title" id="title"></div>
          <div id="img_profile"></div>
          <div class="profile__right__content">
            <table class="table table-striped table-inverse ">
              <thead class="thead-inverse">
                <tr>
                  <th>STT</th>
                  <th style="width:200px">Tên sản phẩm</th>
                  <th>Giá</th>
                  <th>Khu vực</th>
                  <th>Trạng thái </th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="show">

              </tbody>
            </table>
            <div id="add"></div>
          </div>
        </div>


      </div>
    </div>

    <!-- footer -->
    <div class="footer">
      <div style="text-align: center;">
        <h5>Công ty cổ Phần và Đầu tư thương Mại MMD</h5>
        <h6 style="color: gray;">Tổng Đài chăm sóc Khách Hàng:0989879000</h6>
        <div>
          <p>Copyright © 2007 - 2019 Batdongsan.com.vn.
            <br>Email: hotro@batdongsan.com.vn | cskh@batdongsan.com.vn
            <br>Giấy ĐKKD số: 0104630479 Do Sở Kế hoạch và Đầu tư Thành phố Hà Nội cấp lần đầu ngày 02/06/2010
            <br>Giấy phép ICP số 3399/GP-STTTT do Sở Thông tin và Truyền thông Hà Nội cấp ngày 4 tháng 9 năm 2014.
            <br>Chịu trách nhiệm nội dung: Bà Trần Thị Hồng Thúy - ® Ghi rõ nguồn "Batdongsan.com.vn" khi phát hành lại
            thông tin từ
            website này.
            Toàn bộ quy chế, quy định giao dịch chung được đăng tải trên website áp dụng từ ngày 20/02/2019.
          </p>
        </div>
      </div>
      <img src="img/dadangki.jpg" alt="">
    </div>
    <script src="trangchu.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.js"
      integrity="sha256-BTlTdQO9/fascB1drekrDVkaKd9PkwBymMlHOiG+qLI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"></script>
    <script src="js/lib/jquery.validate.min.js"></script>
    <script src="js/lib/additional-methods.min.js"></script>
    <script src="js/lib/jquery.cookie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
    <script src="common.js"></script>
    <script src="index.js"></script>
    <script>
      $('#sanpham').hide()
      $('#profile__right').hide()

      let tokenID = $.cookie('tokenId');
      tokenID && tokenID.length > 0 ? ($('#dangki').text("Xin chào"),$('#dangnhap').html(''),profile()) : window.location.replace('/')
      $('#dangnhap').click(() => {
        $.removeCookie('tokenId', { path: "/" });
        window.location.reload()

      })


      $('#change_profile').click(() => {
       profile()
      })
      function profile(){
         $('#sanpham').hide()
        $('#profile__right').show()
        $('#profile__right').html("<img src='/img/loading.gif'style='width: 260px;margin-left:200px;' >")
        axios.post('/api/user/getinfor', {}, {
          headers: { "Authorization": "Bearer " + $.cookie('tokenId') }
        }).then(res => {
          let data = res.data.data[0]
          data.isactive == 0 ? data.isactive = "true" : data.isactive = "fasle"
          data.tendangnhap == null ? data.tendangnhap = "undefined" : ""
          console.log(data)
          let html = '<div class="profile__right__title">Thông tin cá nhân</div>'
          html += '<div id="img_profile"></div>'
          html += '<div >'
          html += '<div style="display:flex"><span style="width:25%">        Tên đăng nhập:</span><input class=" input__ttuser" type="text " id="tendangnhap" placeholder=' + data.tendangnhap.replace(/\s/g, "_") + ' ></div>'
          html += '<div style="display:flex"><span style="width:25%">        Email:</span><input class=" input__ttuser" type="text " id="new_email" placeholder=' + data.email + ' ></div>'
          html += '<div style="display:flex"><span style="width:25%">Số điện thoại:</span><input  class=" input__ttuser" type="text " id="new_sodienthoai" placeholder=' + data.sodienthoai + ' ></span></div>'
          html += '<div style="display:flex"><span style="width:25%">Active:</span>' + data.isactive + ' </div>'
          html += '<div style="display:flex"><span style="width:25%">Ngày sinh:</span><input class=" input__ttuser" type="text" id="ngaysinh" placeholder=' + data.ngaysinh + '  ></div>'
          html += '<div style="display:flex"><span style="width:25%">Địa chỉ:</span><input class=" input__ttuser" type="text" id="diachi" placeholder=' + data.diachi.replace(/\s/g, "_") + '  ></div>'
          html += '<div style="display:flex;margin-left: 290px"><span style="display:flex"  onclick="send_profile()"><div id="loading"></div><p class="check">Cập nhật</p></span></div>'
          html += '<div id="dialog" class="hidden"></div>'
          html += '</div>'
          $('#profile__right').html(html)
          $('#img_profile').html("<div style='text-align:center'><i class='fa fa-user-circle col-xs-12 col-md-12' aria-hidden='true' style='font-size:150px'></i><p style='font-size:50px'>" + data.tendangnhap + "</p></div>")
        })
      }

      $('#change_password').click(() => {
        let html = '<div class="profile__right__title">thay mật khẩu</div>'

        html += '<input class=" input__changemk" type="password" id="old_password" placeholder="Mật khẩu cũ" >'
        html += '<input  class=" input__changemk" type="password" id="new_password" placeholder="Mật khẩu mới" >'
        html += '<div style="display:flex;margin-left: 290px"><span style="display:flex"  onclick="send_password()"><div id="loading"></div><p class="check">Thay mật khẩu</p></span></div>'
        html += '<div id="dialog" class="hidden"></div>'
        $('#profile__right').html(html)
      })
      function send_profile() {
        $('#loading').html("<img src='/img/loading.gif'style='width: 60px;margin-top: -9px;' >")
        let email = $('#new_email').val()
        let sodienthoai = $('#new_sodienthoai').val()
        let diachi = $('#diachi').val()
        let ngaysinh = $('#ngaysinh').val()
        let tendangnhap = $('#tendangnhap').val()
        console.log(email + "   " + sodienthoai + "  " + diachi + "  " + ngaysinh)
        axios.post('/api/user/update', { email, sodienthoai, diachi, ngaysinh, tendangnhap }, {
          headers: { "Authorization": "Bearer " + $.cookie('tokenId') }
        }).then(res => {
          console.log(res.data)
          if (res.data.code == 1000) {
            $('#dialog').html('<div class="dialogsucess " >success</div>')
            $('#loading').html("<div></div>")
          }
          else {
            $('#loading').html("<div></div>")
            $('#dialog').html('<div class="dialog">' + res.data.message + '</div>')
          }
        })
      }

      function send_password() {

        let old_password = $('#old_password').val()
        let new_password = $('#new_password').val()
        if (old_password.length < 6) {
          $('#old_password').focus()
          $('#dialog').html('<div class="dialog" style="color:red;">Mat khau cu khong hop le</div>')
        }
        else if (new_password.length < 6) {
          $('#new_password').focus()
          $('#dialog').html('<div class="dialog" style="color:red;">Mat khau hon 6 ki tu</div>')
        }

        else {
          $('#loading').html("<img src='/img/loading.gif'style='width: 60px;margin-top: -9px;' >")
          axios.post('/api/user/change_password', { old_password, new_password },
            { headers: { "Authorization": "Bearer " + $.cookie('tokenId') } }).then(res => {
              if (res.data.code = 1000) {

              }
              $('#loading').html("<div></div>")
              $('#dialog').html('<div class="dialog">' + res.data.message + '</div>')
            })
        }


      }


      function loaisp(id, id_loai) {
        console.log("--------------" + id + "-----------------" + id_loai)
        $('#sanpham').show()
        $('#profile__right').hide()
        if (id_loai == 2) {
          $('#title').html("<span>Danh sách tin rao bán</span>")
        }
        else if (id_loai == 3) {
          $('#title').html("<span>Danh sách tin cho thuê</span>")
        } else $('#title').html("<span>Danh sách tin cần mua - cần thuê</span>")
        axios.post('/api/sanpham/getbyuser?id=' + id + '&&id_loaisp=' + id_loai, {}, {
          headers: { "Authorization": "Bearer " + $.cookie('tokenId') }
        }).then(res => {
          console.log(res)
          if (res.data.data.length == 0) {
            $('#show').html("<span>Không có dữ liệu</span>")
            $('#add').html('')
          }
          else {
            let thue = ''
            let id = 0
            res.data.data.map(x => {
              id = x.id
              thue += "<tr>"
              console.log(x)
              x.trangthai === "Yes" ? x.trangthai = "đã thanh toán" : x.trangthai = "chưa thanh toán"
              thue += '<td scope="row"><a href=' + '"/chitiet?id=' + x.id + '">' + x.id + '</a></td>'
              thue += '<td style="width:200px">' + x.tensp + '</td>'
              thue += '<td >' + x.gia + '</td>'
              thue += '<td >' + x.diachi + '</td>'
              thue += '<td >' + x.trangthai + '</td>'
              thue += '<td style="display:flex;">'
              if (x.trangthai === "đã thanh toán") {
                thue += '<div onclick="xoa(' + x.id + ')"><i class="fa fa-remove"aria-hidden="true"></i><div></td>'
              }
              else {
                thue += '<div onclick="thanhtoan(' + x.id + ')"><i class="fas fa-money " aria-hidden="true"></i></div>' +
                  ' /<div onclick="kiemtra(' + x.id + ')"><i class="fa fa-check-circle" aria-hidden="true"></i></div>/ <div onclick="xoa(' + x.id + ')"><i class="fa fa-remove"aria-hidden="true"></i><div></td>'
              }
              thue += "</tr>"
            })
            let df = id + id_loai
            if (res.data.data.length == 10)
              $('#add').html("<span onclick='loaisp(" + id + ',' + id_loai + ")' style='color:blue'>Tiep</span>")

            $('#show').html(thue)
          }

        })
      }
      $('#ban').click(() => {
        loaisp(10000000, 2)
      })
      $('#thue').click(() => {
        loaisp(10000000, 3)
      })
      $('#canban-thue').click(() => {
        loaisp(10000000, 4)
      })
      function kiemtra(x) {
        console.log(x)
        axios.post('/api/momo/kiemtra?id=' + x, {}, {
          headers: { "Authorization": "Bearer " + $.cookie('tokenId') }
        }).then(res => {
          console.log(res.data)
          alert(res.data.data.message)
        })
      }

      function thanhtoan(x) {
        console.log(x)
        if (window.confirm("Bạn chỉ có duy nhất 1 lần thanh toán. Nếu thanh toán thất bại, sản phẩm sẽ bị xóa vào ngày mai. Bạn tiếp tục?"))
          axios.post('/api/momo/thanhtoan', { id: x }, {
            headers: { "Authorization": "Bearer " + $.cookie('tokenId') }
          }).then(res => {
            console.log(res)
            if (res.data.code == 1000) {
              window.location.replace(res.data.data.url)
            }
            else alert(res.data.data.message)
          })
      }
      function xoa(id) {
        console.log(id + "dele")
        if (window.confirm("Bạn muốn xóa sản phẩm này?"))
          axios.post('/api/sanpham/delete', { id }, {
            headers: { "Authorization": "Bearer " + $.cookie('tokenId') }
          }).then(res => {
            console.log(res.data.data)
            alert(res.data.message)
          })
      }
    </script>
    <style>
      .input__changemk {
        width: 450px;
        margin-bottom: 33px;
        margin-left: 148px;
        height: 40px;
        box-shadow: 2px 2px 2px #9593d0;
      }

      .input__ttuser {
        width: 75%;
        margin-bottom: 33px;
        height: 40px;
        border: none;
      }

      .check {
        color: white;
        font-size: 14pt;
        background: #577ade;
        height: 40px;
        line-height: 40px;
        width: 154px;
        text-align: center;

        border-radius: 6px;
      }

      #dialog {
        text-align: center;
        margin-bottom: 20px;
      }

      .dialog {
        color: red;
      }

      .dialog:first-child {
        color: blue;
      }

      .dialogsucess {
        color: white;
        background: green;
        height: 30px;
        text-align: center;
        font-size: 15pt;
        border-radius: 6px;
        box-shadow: 2px 2px 2px yellow;
        width: 460px;
        margin-left: 150px
      }

      span:hover {
        cursor: pointer;
      }
    </style>
  </div>
</body>

</html>